#!/bin/bash
#
# Pre-build Apache Cassandra Analytics
#
# This script clones and builds the cassandra-analytics library using JDK 11
# (required by cassandra-analytics). Uses SDKMAN to temporarily switch to JDK 11.
#
# Modules that support Maven publishing are published to ~/.m2/repository.
# Internal modules (five-zero, etc.) are built and available in build output.
#

set -e

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "$SCRIPT_DIR/.." && pwd)"

ANALYTICS_DIR="$PROJECT_ROOT/.cassandra-analytics"

# Parse arguments
FORCE_REBUILD=false
ANALYTICS_BRANCH="trunk"

while [[ $# -gt 0 ]]; do
    case $1 in
        --force)
            FORCE_REBUILD=true
            shift
            ;;
        --branch)
            ANALYTICS_BRANCH="$2"
            shift 2
            ;;
        *)
            echo "Unknown option: $1"
            echo "Usage: $0 [--force] [--branch <branch>]"
            exit 1
            ;;
    esac
done

# Check if already built by looking for Maven artifacts (any version)
MAVEN_ARTIFACT_BASE="$HOME/.m2/repository/org/apache/cassandra/cassandra-analytics-core_spark3_2.12"
if [ -d "$MAVEN_ARTIFACT_BASE" ] && [ "$(find "$MAVEN_ARTIFACT_BASE" -name '*.jar' 2>/dev/null | head -1)" ] && [ "$FORCE_REBUILD" = false ]; then
    echo "Cassandra Analytics already built (found artifacts in $MAVEN_ARTIFACT_BASE)"
    echo "Use --force to rebuild"
    exit 0
fi

echo "=== Building Apache Cassandra Analytics (requires JDK 11) ==="

# Clone or update the repository
if [ -d "$ANALYTICS_DIR" ]; then
    echo "=== Updating existing clone ==="
    (cd "$ANALYTICS_DIR" && git fetch origin && git checkout "$ANALYTICS_BRANCH" && git pull origin "$ANALYTICS_BRANCH" 2>/dev/null || true)
else
    echo "=== Cloning cassandra-analytics ==="
    git clone --depth 1 --branch "$ANALYTICS_BRANCH" https://github.com/apache/cassandra-analytics.git "$ANALYTICS_DIR"
fi

# Initialize SDKMAN
if [ -f "$HOME/.sdkman/bin/sdkman-init.sh" ]; then
    source "$HOME/.sdkman/bin/sdkman-init.sh"
else
    echo "Error: SDKMAN not found. It should be installed in the devcontainer."
    exit 1
fi

# Switch to JDK 11 (required by cassandra-analytics)
echo "=== Switching to JDK 11 via SDKMAN ==="
sdk use java 11.0.25-tem || {
    echo "Error: JDK 11 not found. Install with: sdk install java 11.0.25-tem"
    exit 1
}

cd "$ANALYTICS_DIR"

# Build only the modules we need (skip integration-framework which needs dtest jars)
echo "=== Building required modules ==="
./gradlew clean \
    :cassandra-analytics-core:assemble \
    :cassandra-bridge:assemble \
    :cassandra-five-zero:assemble \
    :cassandra-five-zero-bridge:assemble \
    :cassandra-five-zero-types:assemble \
    :cassandra-analytics-common:assemble \
    :cassandra-analytics-sidecar-client:assemble \
    :cassandra-analytics-spark-converter:assemble \
    :cassandra-analytics-spark-five-zero-converter:assemble \
    -x test \
    -x javadoc \
    -x checkstyleMain \
    -x checkstyleTest \
    -x checkstyleTestFixtures \
    -x rat

# Publish common modules first (artifactType=common)
echo "=== Publishing common modules to local Maven ==="
./gradlew \
    :analytics-sidecar-client-common:publishToMavenLocal \
    :analytics-sidecar-vertx-client:publishToMavenLocal \
    :analytics-sidecar-vertx-client-shaded:publishToMavenLocal \
    :cassandra-analytics-common:publishToMavenLocal \
    :cassandra-analytics-sidecar-client:publishToMavenLocal \
    -PartifactType=common \
    -x test \
    -x javadoc \
    -x checkstyleMain \
    -x checkstyleTest \
    -x checkstyleTestFixtures \
    -x rat

# Publish spark modules (artifactType=spark)
echo "=== Publishing spark modules to local Maven ==="
./gradlew \
    :cassandra-analytics-core:publishToMavenLocal \
    :cassandra-bridge:publishToMavenLocal \
    :cassandra-analytics-spark-converter:publishToMavenLocal \
    -PartifactType=spark \
    -x test \
    -x javadoc \
    -x checkstyleMain \
    -x checkstyleTest \
    -x checkstyleTestFixtures \
    -x rat

echo ""
echo "=== Build complete ==="
echo "Maven artifacts: ~/.m2/repository/org/apache/cassandra/"
echo "Build output: $ANALYTICS_DIR/*/build/libs/"
