#!/bin/bash
#
# Debug the Victoria Logs pipeline
# Checks: OTel Collector pods, Victoria Logs
#
# Don't exit on error - we want to see all diagnostic output
set +e

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "$SCRIPT_DIR/.." && pwd)"

# Disable AWS CLI pager
export AWS_PAGER=""

# Source env.sh for SSH aliases
if [ -f "$PROJECT_ROOT/env.sh" ]; then
    source "$PROJECT_ROOT/env.sh"
fi

if [ ! -f "$PROJECT_ROOT/state.json" ]; then
    echo "Error: state.json not found. Is a cluster running?"
    exit 1
fi

# Get cluster info
CONTROL_IP=$(jq -r '.controlHost.publicIp // .hosts.Control[0].publicIp' "$PROJECT_ROOT/state.json")

echo "=== Log Pipeline Debug ==="
echo "Control IP: $CONTROL_IP"
echo ""

# Step 1: Check OTel Collector DaemonSet
echo "=== Step 1: OTel Collector DaemonSet Status ==="
kubectl get pods -l app.kubernetes.io/name=otel-collector -o wide 2>&1 || echo "Error checking OTel Collector pods"
echo ""

# Step 2: OTel Collector logs
echo "=== Step 2: OTel Collector Logs (last 30 lines) ==="
kubectl logs -l app.kubernetes.io/name=otel-collector --tail=30 2>&1 || echo "Error getting OTel Collector logs"
echo ""

# Step 3: Victoria Logs pod
echo "=== Step 3: Victoria Logs Pod Status ==="
kubectl get pods -l app=victorialogs -o wide 2>&1 || echo "Error checking Victoria Logs pod"
echo ""

# Step 4: Victoria Logs recent entries
echo "=== Step 4: Victoria Logs - Recent Logs ==="
if [ -n "$CONTROL_IP" ] && [ "$CONTROL_IP" != "null" ]; then
    echo "Querying all logs (last 1h)..."
    curl -s "http://$CONTROL_IP:9428/select/logsql/query?query=*&limit=10" 2>/dev/null | head -20 || echo "Error querying Victoria Logs"
else
    echo "Control IP not available"
fi
echo ""

# Step 5: Check cluster-config ConfigMap
echo "=== Step 5: Cluster Config ConfigMap ==="
kubectl get configmap cluster-config -o yaml 2>&1 || echo "ConfigMap not found"
echo ""

echo "=== Debug Complete ==="
