apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: clickhouse
  namespace: default
  labels:
    app.kubernetes.io/name: clickhouse-server
spec:
  serviceName: clickhouse
  replicas: 2
  podManagementPolicy: Parallel
  selector:
    matchLabels:
      app.kubernetes.io/name: clickhouse-server
  template:
    metadata:
      labels:
        app.kubernetes.io/name: clickhouse-server
    spec:
      hostNetwork: true
      dnsPolicy: ClusterFirstWithHostNet
      nodeSelector:
        type: db
      affinity:
        podAntiAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
            - labelSelector:
                matchLabels:
                  app.kubernetes.io/name: clickhouse-server
              topologyKey: kubernetes.io/hostname
      initContainers:
        - name: wait-for-keeper
          image: busybox:1.36
          command:
            - /bin/sh
            - -c
            - |
              echo "Waiting for ClickHouse Keeper to be ready..."
              until nc -z clickhouse-keeper-0.clickhouse-keeper.default.svc.cluster.local 2181; do
                echo "Keeper not ready, sleeping..."
                sleep 5
              done
              echo "Keeper is ready!"
        - name: init-data-dir
          image: busybox:1.36
          command:
            - /bin/sh
            - -c
            - |
              mkdir -p /mnt/db1/clickhouse
              mkdir -p /mnt/db1/clickhouse/tmp
              mkdir -p /mnt/db1/clickhouse/user_files
              mkdir -p /mnt/db1/clickhouse/format_schemas
              mkdir -p /mnt/db1/clickhouse/disks/s3_disk
              mkdir -p /mnt/db1/clickhouse/disks/s3_cache
              mkdir -p /mnt/db1/clickhouse/logs
              chown -R 101:101 /mnt/db1/clickhouse
          volumeMounts:
            - name: data
              mountPath: /mnt/db1/clickhouse
      containers:
        - name: clickhouse
          image: clickhouse/clickhouse-server:latest
          securityContext:
            runAsUser: 101
            runAsGroup: 101
          ports:
            - containerPort: 8123
              hostPort: 8123
              name: http
            - containerPort: 9000
              hostPort: 9000
              name: native
            - containerPort: 9009
              name: interserver
            - containerPort: 9363
              name: metrics
          env:
            - name: REPLICA
              valueFrom:
                fieldRef:
                  fieldPath: metadata.name
            - name: REPLICAS_PER_SHARD
              valueFrom:
                configMapKeyRef:
                  name: clickhouse-cluster-config
                  key: replicas-per-shard
            - name: CLICKHOUSE_S3_CACHE_SIZE
              valueFrom:
                configMapKeyRef:
                  name: clickhouse-cluster-config
                  key: s3-cache-size
            - name: CLICKHOUSE_S3_CACHE_ON_WRITE
              valueFrom:
                configMapKeyRef:
                  name: clickhouse-cluster-config
                  key: s3-cache-on-write
          envFrom:
            - secretRef:
                name: clickhouse-s3-credentials
                optional: true
          command:
            - /bin/bash
            - -c
            - |
              # Calculate shard from pod ordinal
              # REPLICA env var is the pod name (clickhouse-X), extract X and compute shard
              # Note: Can't use $HOSTNAME because hostNetwork=true makes it the EC2 hostname
              ORDINAL=${REPLICA##*-}
              export SHARD=$(( (ORDINAL / REPLICAS_PER_SHARD) + 1 ))
              echo "Pod $REPLICA: ordinal=$ORDINAL, SHARD=$SHARD, REPLICAS_PER_SHARD=$REPLICAS_PER_SHARD"
              umask 0022
              exec /entrypoint.sh
          resources:
            # To set memory limits, add:
            # limits:
            #   memory: 4Gi
            requests:
              memory: 2Gi
              cpu: 500m
          volumeMounts:
            - name: config
              mountPath: /etc/clickhouse-server/config.d
              readOnly: true
            - name: users
              mountPath: /etc/clickhouse-server/users.d
              readOnly: true
            - name: data
              mountPath: /mnt/db1/clickhouse
          livenessProbe:
            httpGet:
              path: /ping
              port: 8123
            initialDelaySeconds: 30
            periodSeconds: 15
          readinessProbe:
            httpGet:
              path: /ping
              port: 8123
            initialDelaySeconds: 10
            periodSeconds: 10
      volumes:
        - name: config
          configMap:
            name: clickhouse-server-config
            items:
              - key: config.xml
                path: config.xml
        - name: users
          configMap:
            name: clickhouse-server-config
            items:
              - key: users.xml
                path: users.xml
  volumeClaimTemplates:
    - metadata:
        name: data
        labels:
          app.kubernetes.io/name: clickhouse-server
      spec:
        accessModes: ["ReadWriteOnce"]
        storageClassName: local-storage
        resources:
          requests:
            storage: 100Gi
