apiVersion: apps/v1
kind: Deployment
metadata:
  name: grafana
  namespace: default
  labels:
    app.kubernetes.io/name: grafana
spec:
  replicas: 1
  selector:
    matchLabels:
      app.kubernetes.io/name: grafana
  strategy:
    type: Recreate
  template:
    metadata:
      labels:
        app.kubernetes.io/name: grafana
    spec:
      hostNetwork: true
      dnsPolicy: ClusterFirstWithHostNet
      nodeSelector:
        node-role.kubernetes.io/control-plane: "true"
      tolerations:
        - key: node-role.kubernetes.io/control-plane
          operator: Exists
          effect: NoSchedule
      securityContext:
        fsGroup: 472
        runAsUser: 472
      containers:
        - name: grafana
          image: grafana/grafana:latest
          ports:
            - containerPort: 3000
              hostPort: 3000
              protocol: TCP
          env:
            - name: GF_INSTALL_PLUGINS
              value: grafana-clickhouse-datasource,victoriametrics-logs-datasource,grafana-pyroscope-datasource
            - name: GF_SECURITY_ADMIN_USER
              value: admin
            - name: GF_SECURITY_ADMIN_PASSWORD
              value: admin
            - name: GF_USERS_ALLOW_SIGN_UP
              value: "false"
            - name: GF_AUTH_ANONYMOUS_ENABLED
              value: "true"
            - name: GF_USERS_DEFAULT_ORG_NAME
              value: "Main Org."
            - name: GF_AUTH_ANONYMOUS_ORG_NAME
              value: "Main Org."
            - name: GF_AUTH_ANONYMOUS_ORG_ROLE
              value: Admin
            - name: GF_AUTH_DISABLE_LOGIN_FORM
              value: "false"
            - name: GF_AUTH_BASIC_ENABLED
              value: "true"
            - name: GF_BRANDING_APP_TITLE
              value: "__CLUSTER_NAME__"
            - name: GF_DASHBOARDS_DEFAULT_HOME_DASHBOARD_PATH
              value: "/var/lib/grafana/dashboards/system/system-overview.json"
          resources:
            limits:
              memory: 256Mi
            requests:
              memory: 128Mi
              cpu: 50m
          volumeMounts:
            - name: datasources
              mountPath: /etc/grafana/provisioning/datasources
              readOnly: true
            - name: dashboards-config
              mountPath: /etc/grafana/provisioning/dashboards
              readOnly: true
            - name: dashboard-system
              mountPath: /var/lib/grafana/dashboards/system
              readOnly: true
            - name: dashboard-clickhouse
              mountPath: /var/lib/grafana/dashboards/clickhouse
              readOnly: true
            - name: dashboard-clickhouse-logs
              mountPath: /var/lib/grafana/dashboards/clickhouse-logs
              readOnly: true
            - name: dashboard-s3
              mountPath: /var/lib/grafana/dashboards/s3
              readOnly: true
            - name: dashboard-emr
              mountPath: /var/lib/grafana/dashboards/emr
              readOnly: true
            - name: dashboard-opensearch
              mountPath: /var/lib/grafana/dashboards/opensearch
              readOnly: true
            - name: dashboard-stress
              mountPath: /var/lib/grafana/dashboards/stress
              readOnly: true
            - name: data
              mountPath: /var/lib/grafana
          livenessProbe:
            httpGet:
              path: /api/health
              port: 3000
            initialDelaySeconds: 30
            periodSeconds: 15
          readinessProbe:
            httpGet:
              path: /api/health
              port: 3000
            initialDelaySeconds: 5
            periodSeconds: 10
      volumes:
        - name: datasources
          configMap:
            name: grafana-datasources
        - name: dashboards-config
          configMap:
            name: grafana-dashboards-config
        - name: dashboard-system
          configMap:
            name: grafana-dashboard-system
        - name: dashboard-clickhouse
          configMap:
            name: grafana-dashboard-clickhouse
            optional: true
        - name: dashboard-clickhouse-logs
          configMap:
            name: grafana-dashboard-clickhouse-logs
            optional: true
        - name: dashboard-s3
          configMap:
            name: grafana-dashboard-s3
            optional: true
        - name: dashboard-emr
          configMap:
            name: grafana-dashboard-emr
            optional: true
        - name: dashboard-opensearch
          configMap:
            name: grafana-dashboard-opensearch
            optional: true
        - name: dashboard-stress
          configMap:
            name: grafana-dashboard-stress
            optional: true
        - name: data
          emptyDir: {}
